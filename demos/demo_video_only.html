<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />  <!--skip-->
        <title>NPU DCE Student: Chu-Chi Liu</title>
        <!--<title>EasyRTC Demo: Video Only</title>-->
                <link rel="stylesheet" type="text/css" href="/easyrtc/easyrtc.css" />

        <!--hide-->
        <!--<link rel="stylesheet" type="text/css" href="css/landing.css" />-->


        <!-- Prettify Code -->
        <script type="text/javascript" src="js/prettify/prettify.js"></script>
        <script type="text/javascript" src="js/prettify/loadAndFilter.js"></script>
        <script type="text/javascript" src="js/prettify/jquery.min.js"></script>

        <link rel="stylesheet" type="text/css" href="js/prettify/prettify.css" />
        <!--show-->
        <!-- Assumes global locations for socket.io.js and easyrtc.js -->
        <script src="/socket.io/socket.io.js"></script>
        <script type="text/javascript" src="/easyrtc/easyrtc.js"></script>
        <script type="text/javascript" src="js/demo_video_only.js"></script>
        <!--hide-->
        <!-- Styles used within the demo -->
        <style type="text/css">
            #videoDemoContainer {
                position:relative;
            }
            #connectControls {
                float:left;
                width:250px;
                text-align:center;
                border: 2px solid black;
                background-color: darkgrey;
            }
            #otherClients {
                height:200px;
                overflow-y:scroll;
            }
            #selfVideo {
                height:225px;
                width:300px;
                float:left;
                border:1px solid gray;
                margin-left:10px;
            }
            #callerVideo {
                height:225px;
                width:300px;
                border:1px solid gray;
                margin-left:10px;
            }
            #acceptCallBox {
                display:none;
                z-index:2;
                position:absolute;
                top:100px;
                left:400px;
                border:red solid 2px;
                background-color:pink;
                padding:15px;
            }
            #recognizedAs {
                float:left;
            }
            #recognizedUser {
                float:left;
            }
            #confidenceLv {
                float:left;
            }
            #recognizedConfi {
                float:left;
            }
        </style>
        <!--show-->
    </head>
    <body>
        <!--hide-->
        <div id="container">

            <!--<div id="header">-->
                <!--<a href="index.html"><img id="logo_easyrtc" src="images/easyrtc_logo.png" alt="EasyRTC" style="" /></a>-->
            <!--</div>-->
            <!--<div id="menu"><a class="menu_link" href="index.html"><div class="menu_item">Local Demos</div></a><a class="menu_link" href="https://github.com/priologic/easyrtc/tree/master/docs"><div class="menu_item">Documentation</div></a><a class="menu_link" href="https://easyrtc.com/forums/"><div class="menu_item">Support: EasyRTC Forums</div></a><a class="menu_link" href="http://www.easyrtc.com/"><div class="menu_item">EasyRTC.com</div></a></div>-->

            <div id="main">
                <!-- Main Content -->

                <h1>Real Time Video Only Communication With Face Recognition</h1>
                <!--<h1>EasyRTC Demo: Video Only</h1>-->

                <!--<p>The application provides a video-only chat by disabling audio before initializing the local media stream.</p>-->

                <!--<p>To use it, press the Connect button.-->
                    <!--You should see buttons representing other people using the video-only chat page.-->
                    <!--Click one of those buttons to initiate a chat.</p>-->

                <!--<hr />-->
                <!--<h2>The Demo</h2>-->
                <!--show-->
                <div id="videoDemoContainer">
                    <div id="connectControls">
                        <button id="connectButton" onclick="connect()">Connect</button>
                        <button id="hangupButton" disabled="disabled" onclick="hangup()">Hangup</button>
                        <div id="iam">Not yet connected...</div>
                        <br />
                        <strong>Connected users:</strong>
                        <div id="otherClients"></div>



                        <strong id="recognizedAs">Recognized As: </strong>
                        <br/>
                        <span id="recognizedUser"></span>
                        <br/>
                        <strong id="confidenceLv">Confidence Lv: </strong>
                        <br/>
                        <span id="recognizedConfi">
                            <script type="text/javascript">

                                // below are used ...
                                var resetCookieEnabled = false;
                                var showCookieEnabled = false;
                                var detectEnabled = false;
                                var recognizeEnabled = true;//false;
                                var localDetectEnabled = false;
                                var localRecognizeEnabled = true;//false;
                                var remoteDetectEnabled = false;
                                var remoteRecognizeEnabled = true;//false;

                                var recognizeLogEnabled = true;//false;// for ui
                                var recognizeLogEnabled2 = true;//false;// for ui
                                var remoteRecognizeLogEnabled = true;//false;// for interval
                                var localRecognizeLogEnabled = true;//false;// for interval
                                var remoteRecognizeLogEnabled2 = true;//false;// for interval
                                var localRecognizeLogEnabled2 = true;//false;// for interval

                                var cameraHeaderTextEnabled = false;
                                var canvasHeaderTextEnabled = false;

                                var textAndTrainingHeaderTextEnabled = false;

                                var localSnapBtnEnabled = false;
                                var localDetectBtnEnabled = false;
                                var localRecognizeBtnEnabled = false;

                                var remoteSnapBtnEnabled = false;
                                var remoteDetectBtnEnabled = false;
                                var remoteRecognizeBtnEnabled = false;

                                var remoteTrainingEnabled = false;// not implemented anyway ....
                                var localTrainingEnabled = false;
                                var trainingRowEnabled = false;

                                var isInitializer      = false;
                                var isListener         = true;
//                                var   listenerFileName = "_remoteRecognize.png";
                                var   listenerFileName = "_localRecognize.png";

                            </script>
                        </span>



                    </div>

                    <div id="videos">

                        <table border="1">
                            <tr id="cameraHeaderText">
                                <td colspan="2">
                                    Below is from Self's camera.
                                </td>
                                <td colspan="2">
                                    Below is from Caller's camera.
                                </td>
                            </tr>
                            <tr>
                                <td colspan="2">
                                    <video autoplay="autoplay" id="selfVideo" class="easyrtcMirror" width="320" height="240"></video>
                                </td>
                                <td colspan="2">
                                    <video autoplay="autoplay" id="callerVideo" width="320" height="240"></video>
                                </td>
                            </tr>
                            <tr id="textAndTrainingHeaderText">
                                <td>
                                    Test
                                </td>
                                <td>
                                    Training
                                </td>
                                <td>
                                    Test
                                </td>
                                <td>
                                    Training (NOT IMPL.)
                                </td>
                            </tr>
                            <tr id="trainingRow">
                                <td>
                                    <button id="selfSnap"        class="sexyButton">Self Snap            </button>
                                    <button id="selfDetect"      class="sexyButton">Self Snap/Detect</button>
                                    <button id="selfRecognize"   class="sexyButton">Self Recognize </button>
                                </td>
                                <td id="selfTrainingParent">
                                    <!--<form>-->
                                        <label>User Name    :</label><input  id="selfId"   type="text"><br>
                                        <label>User Password:</label><input  id="selfPwd"  type="text"><br>
                                        <button id="selfTraining" class="sexyButton">Take PictureSss...</button>
                                    <!--</form>-->
                                </td>
                                <td>
                                    <button id="callerSnap"      class="sexyButton">Caller Snap                </button>
                                    <button id="callerDetect"    class="sexyButton">Caller Snap/Detect</button>
                                    <button id="callerRecognize" class="sexyButton">Caller Recognize </button>
                                </td>
                                <td id="callerTrainingParent">
                                    <!--<form>-->
                                        <label>User Name    :</label><input  id="callerId"   type="text"><br>
                                        <label>User Password:</label><input  id="callerPwd"  type="text"><br>
                                        <button id="callerTraining" class="sexyButton">Take PictureSss...</button>
                                    <!--</form>-->
                                </td>
                            </tr>
                            <tr id="canvasHeaderText">
                                <td colspan="2">
                                    Below is from [Self Snap] button.
                                </td>
                                <td colspan="2">
                                    Below is from [Caller Snap] button.
                                </td>
                            </tr>
                            <tr>
                                <td colspan="2">
                                    <canvas id="selfCanvas" width="320" height="240"></canvas>
                                </td>
                                <td colspan="2">
                                    <canvas id="callerCanvas" width="320" height="240"></canvas>
                                </td>
                            </tr>
                            <tr id="detectParent">
                                <td colspan="2">
                                    Below is from [Self Snap + Self Detect] button.
                                </td>
                                <td colspan="2">
                                    Below is from [Caller Snap + Caller Detect] button.
                                </td>
                            </tr>
                            <tr id="detectParent2">
                                <td colspan="2">
                                    <img id="selfImage" width="320" height="240"></img>
                                </td>
                                <td colspan="2">
                                    <img id="callerImage" width="320" height="240"></img>
                                </td>
                            </tr>
                            <tr id="recognizeParent">
                                <td colspan="2">
                                    Below is from [Self Recognize] button.
                                </td>
                                <td colspan="2">
                                    Below is from [Caller Recognize] button.
                                </td>
                            </tr>
                            <tr id="recognizeParent2">
                                <td colspan="2">
                                    <img id="selfImage2" width="320" height="240"></img>
                                </td>
                                <td colspan="2">
                                    <img id="callerImage2" width="320" height="240"></img>
                                </td>
                            </tr>
                            <tr id="recognizeLogParent">
                                <td colspan="2">
                                    <textarea id='selfLog' rows="3" cols="42"></textarea>
                                    <!--<textarea id='selfLog' rows="10" cols="59"></textarea>-->
                                    <!--<p id='selfLog'></p>-->
                                </td>
                                <td colspan="2">
                                    <textarea id='callerLog' rows="3" cols="42"></textarea>
                                    <!--<textarea id='callerLog' rows="10" cols="59"></textarea>-->
                                    <!--<p id='callerLog'></p>-->
                                </td>
                            </tr>

                            <tr id="recognizeLogParent2">
                                <td colspan="2">
                                    <textarea id='selfLog2' rows="9" cols="42"></textarea>
                                    <!--<textarea id='selfLog' rows="10" cols="59"></textarea>-->
                                    <!--<p id='selfLog'></p>-->
                                </td>
                                <td colspan="2">
                                    <textarea id='callerLog2' rows="9" cols="42"></textarea>
                                    <!--<textarea id='callerLog' rows="10" cols="59"></textarea>-->
                                    <!--<p id='callerLog'></p>-->
                                </td>
                            </tr>

                            <tr>
                                <td colspan="2">
                                    <textarea id='selfLog3' rows="9" cols="42"></textarea>
                                </td>
                                <td colspan="2">
                                    <textarea id='callerLog3' rows="9" cols="42"></textarea>
                                </td>
                            </tr>

                            <tr id="resetCookieParent">
                                <td colspan="4">
                                    <button id="setCookie" class="sexyButton">Reset Cookie</button>
                                </td>
                            </tr>
                            <tr id ="showCookieParent">
                                <td colspan="4">
                                    <button id="getCookie" class="sexyButton">Show Cookie</button>
                                </td>
                            </tr>
                        </table>

                        <script>
                            if(resetCookieEnabled == false){
                                document.getElementById("resetCookieParent").style.display = 'none';
                            }
                            if(showCookieEnabled == false){
                                document.getElementById("showCookieParent").style.display = 'none';
                            }
                            if(detectEnabled == false){
                                document.getElementById("detectParent").style.display = 'none';
                                document.getElementById("detectParent2").style.display = 'none';
                            }
                            if(recognizeEnabled == false){
                                document.getElementById("recognizeParent").style.display = 'none';
                                document.getElementById("recognizeParent2").style.display = 'none';
                            }
                            if(recognizeLogEnabled == false){
                                document.getElementById("recognizeLogParent").style.display = 'none';
                            }
                            if(recognizeLogEnabled2 == false){
                                document.getElementById("recognizeLogParent2").style.display = 'none';
                            }
                            if(cameraHeaderTextEnabled == false){
                                document.getElementById("cameraHeaderText").style.display = 'none';
                            }
                            if(canvasHeaderTextEnabled == false){
                                document.getElementById("canvasHeaderText").style.display = 'none';
                            }
                            if(textAndTrainingHeaderTextEnabled == false){
                                document.getElementById("textAndTrainingHeaderText").style.display = 'none';
                            }
                            if(localTrainingEnabled == false){
                                document.getElementById("selfTrainingParent").style.display = 'none';
                            }
                            if(remoteTrainingEnabled == false){
                                document.getElementById("callerTrainingParent").style.display = 'none';
                            }
                            if(remoteSnapBtnEnabled == false){
                                document.getElementById("callerSnap").style.display = 'none';
                            }
                            if(remoteDetectBtnEnabled == false){
                                document.getElementById("callerDetect").style.display = 'none';
                            }
                            if(remoteRecognizeBtnEnabled == false){
                                document.getElementById("callerRecognize").style.display = 'none';
                            }
                            if(localSnapBtnEnabled == false){
                                document.getElementById("selfSnap").style.display = 'none';
                            }
                            if(localDetectBtnEnabled == false){
                                document.getElementById("selfDetect").style.display = 'none';
                            }
                            if(localRecognizeBtnEnabled == false){
                                document.getElementById("selfRecognize").style.display = 'none';
                            }
                            if(trainingRowEnabled == false){
                                document.getElementById("trainingRow").style.display = 'none';
                            }

                            function setMonitor(id, counterS){

                                var counter = Number(counterS);

                                //alert(counter);
                                document.getElementById('recognizedUser').innerHTML = id;

                                var x = document.getElementById('recognizedConfi');
                                if(counter > 7) {
                                    x.style.color = '#00FF00';
                                }
                                else if(counter > 4){
                                    x.style.color = '#FFFF00';// yellow
                                    //x.style.color = '#FFA500';// orange
                                } else {
                                    x.style.color = '#FF0000';
                                }

                                var count;
                                var hist = "";
                                for(count = 0; count < counter; count++){
                                    //document.write(" o ");
                                    //document.getElementById('mySpan').innerHTML = '...'
                                    hist = hist + "@";//" o ";
                                }
                                x.innerHTML = hist;
                            }

                            function lastLog(rowToConsider, logData){
//                                alert(
//                                        rowToConsider + "\n" +
//                                        logData + "\n" +
//                                        logData.split("\n") + "\n" +
//                                        logData.split("\n").length);

                                var lines = logData.split("\n")
                                if(lines.length <= rowToConsider+1){// HAS NEW LINE ...
                                    return ["To Be Determined", "0"];
                                }

                                var minDistance = "1001";
                                var minIndex = -1;
                                var i;
                                for (i = lines.length-2; i > lines.length-2-rowToConsider; i--) {
                                    //alert(lines[i].split(","))
                                    var distance = lines[i].split(",")[2];// score
                                    //alert("distance:"+distance);
                                    if(Number(distance) < Number(minDistance)){
                                        minDistance = distance;
                                        minIndex = i;
                                    }
                                }
                                var minDistanceN = Number(minDistance);
                                var greenUpperBound = 77.7;
                                var diff = 3;//10;//3;
                                var numOfStar = 0;

                                if(       minDistanceN >  greenUpperBound + 6*diff                                            ){
                                    numOfStar = 1;
                                } else if(minDistanceN >  greenUpperBound + 5*diff && minDistanceN <= greenUpperBound + 6*diff){
                                    numOfStar = 2;
                                } else if(minDistanceN >  greenUpperBound + 4*diff && minDistanceN <= greenUpperBound + 5*diff){
                                    numOfStar = 3;
                                } else if(minDistanceN >  greenUpperBound + 3*diff && minDistanceN <= greenUpperBound + 4*diff){
                                    numOfStar = 4;
                                } else if(minDistanceN >  greenUpperBound + 2*diff && minDistanceN <= greenUpperBound + 3*diff){
                                    numOfStar = 5;
                                } else if(minDistanceN >  greenUpperBound + 1*diff && minDistanceN <= greenUpperBound + 2*diff){
                                    numOfStar = 6;
                                } else if(minDistanceN >  greenUpperBound + 0*diff && minDistnaceN <= greenUpperBound + 1*diff){
                                    numOfStar = 7;
                                } else if(minDistanceN >  greenUpperBound - 1*diff && minDistanceN <= greenUpperBound + 0*diff){
                                    numOfStar = 8;
                                } else if(minDistanceN >  greenUpperBound - 2*diff && minDistanceN <= greenUpperBound - 1*diff){
                                    numOfStar = 9;
                                } else if(                                            minDistanceN <= greenUpperBound - 2*diff){
                                    numOfStar = 10;
                                }

                                //alert(lines[minIndex].split(",")[1]);
                                return [lines[minIndex].split(",")[1], ""+numOfStar];
                            }

                            // Converts image to canvas; returns new canvas element
                            function convertImageToCanvas(image) {
                                var canvas = document.createElement("canvas");
                                canvas.width = image.width;
                                canvas.height = image.height;
                                canvas.getContext("2d").drawImage(image, 0, 0);

                                return canvas;
                            }

                            // Converts canvas to an image
                            function convertCanvasToImage(canvas) {
                                var image = new Image();
                                image.src = canvas.toDataURL("image/png");
                                return image;
                            }

                            function getBase64Image(imgElem) {
                                // imgElem must be on the same server otherwise a cross-origin error will be thrown "SECURITY_ERR: DOM Exception 18"
                                var canvas = document.createElement("canvas");
                                canvas.width = imgElem.clientWidth;
                                canvas.height = imgElem.clientHeight;
                                var ctx = canvas.getContext("2d");
                                ctx.drawImage(imgElem, 0, 0);
                                var dataURL = canvas.toDataURL("image/png");
                                return dataURL.replace(/^data:image\/(png|jpg);base64,/, "");
                            }

                            function getBase64Image(img, extension) {
                                // Create an empty canvas element
                                var canvas = document.createElement('canvas');

                                canvas.width = img.naturalWidth;
                                canvas.height = img.naturalHeight;

                                // Copy the image contents to the canvas
                                var ctx = canvas.getContext('2d');
                                ctx.drawImage(img, 0, 0);

                                // Get the data-URL formatted image
                                // Firefox supports PNG and JPEG. You could check img.src to
                                // guess the original format, but be aware the using 'image/jpg'
                                // will re-encode the image.
                                var dataURL = canvas.toDataURL('image/' + extension);

                                return dataURL;
                            }

                            function dataURItoBlob(dataURI) {
                                // convert base64/URLEncoded data component to raw binary data held in a string
                                var byteString;
                                if (dataURI.split(',')[0].indexOf('base64') >= 0)
                                    byteString = atob(dataURI.split(',')[1]);
                                else
                                    byteString = unescape(dataURI.split(',')[1]);

                                // separate out the mime component
                                var mimeString = dataURI.split(',')[0].split(':')[1].split(';')[0];

                                // write the bytes of the string to a typed array
                                var ia = new Uint8Array(byteString.length);
                                for (var i = 0; i < byteString.length; i++) {
                                    ia[i] = byteString.charCodeAt(i);
                                }

                                return new Blob([ia], {type:mimeString});
                            }

                            function uploadFile(e) {
                                var img         = e.target,
                                    imgPath     = img.src,
                                    pathParts   = imgPath.split('/'),
                                    filename    = pathParts[pathParts.length - 1],
                                    extension   = filename.split('.')[1],
                                    imgData     = getBase64Image(img, extension),
                                    formData    = new FormData(),
                                    xhttp       = new XMLHttpRequest(),
                                    file

                                file = dataURItoBlob(imgData)
                                formData.append('uploads[]', file, filename)

                                img.parentElement.classList.remove('img-error')
                                img.parentElement.classList.add('img-uploading')

                                xhttp.onreadystatechange = function() {
                                    if (xhttp.readyState == 4) {
                                        if(xhttp.status == 200) {
                                            setTimeout(showSuccess.bind(this), 1500)
                                        } else {
                                            setTimeout(showError.bind(this), 1500)
                                        }

                                    }
                                }.bind(this);

                                xhttp.open('POST', '/upload');
                                xhttp.send(formData);
                            }

                            function showSuccess() {
                                this.parentElement.classList.remove('img-uploading')
                            }

                            function showError() {
                                this.parentElement.classList.remove('img-uploading')
                                this.parentElement.classList.add('img-error')
                            }

                            function sendEvent(id, context, video, canvas, filename, resultingfilepath, imageElem) {// id never used here ...
                                context.drawImage(video, 0, 0, 320, 240);




                                var image = convertCanvasToImage(canvas);

                                var formData    = new FormData(),
                                    xhttp       = new XMLHttpRequest(),
                                    file        = dataURItoBlob(image.src)

                                formData.append('uploads[]', file, filename)

                                //image.parentElement.classList.remove('img-error')
                                //image.parentElement.classList.add('img-uploading')

                                xhttp.onreadystatechange = function() {
                                    if (xhttp.readyState == 4) {
                                        if(xhttp.status == 200) {
                                            setTimeout(showSuccess.bind(this), 1500)

                                            // Chu-Chi: below necessary ?

                                            sDetect = new Image();
                                            sDetect.src = resultingfilepath; // can also be a remote URL e.g. http://
                                            sDetect.onload = function() {
                                                //console.info("resetting the source ... :)")

                                                d = new Date();
                                                imageElem.attr("src", sDetect.src + "?" + d.getTime());

                                                //canvas.width = canvas.width;
                                                //context.clearRect(0, 0, canvas.width, canvas.height);
                                                //context.drawImage(sDetect,0,0, 320, 240);
                                            };

                                        } else {
                                            setTimeout(showError.bind(this), 1500)
                                        }
                                    }
                                }.bind(this);

                                xhttp.open('POST', '/upload');
                                xhttp.send(formData);
                            }

                            function sendEvent2(context, video, canvas, filename, resultingfilepath, imageElem) {
                                context.drawImage(video, 0, 0, 320, 240);

                                var image = convertCanvasToImage(canvas);

                                var formData    = new FormData(),
                                        xhttp       = new XMLHttpRequest(),
                                        file        = dataURItoBlob(image.src)

                                formData.append('uploads[]', file, filename)

                                //image.parentElement.classList.remove('img-error')
                                //image.parentElement.classList.add('img-uploading')

                                xhttp.onreadystatechange = function() {
                                    if (xhttp.readyState == 4) {
                                        if(xhttp.status == 200) {
                                            setTimeout(showSuccess.bind(this), 1500)

                                            // Chu-Chi: below necessary ?

                                            sDetect = new Image();
                                            sDetect.src = resultingfilepath; // can also be a remote URL e.g. http://
                                            sDetect.onload = function() {
                                                //console.info("resetting the source ... :)")

                                                d = new Date();
                                                imageElem.attr("src", sDetect.src + "?" + d.getTime());

                                                //canvas.width = canvas.width;
                                                //context.clearRect(0, 0, canvas.width, canvas.height);
                                                //context.drawImage(sDetect,0,0, 320, 240);
                                            };

                                        } else {
                                            setTimeout(showError.bind(this), 1500)
                                        }
                                    }
                                }.bind(this);

                                xhttp.open('POST', '/upload');
                                xhttp.send(formData);
                            }

                            Date.prototype.YYYYMMDDHHMMSSMS = function () {
                                var yyyy = this.getFullYear().toString();
                                var MM = pad(this.getMonth() + 1,2);
                                var dd = pad(this.getDate(), 2);
                                var hh = pad(this.getHours(), 2);
                                var mm = pad(this.getMinutes(), 2)
                                var ss = pad(this.getSeconds(), 2)
                                var ms = pad(this.getMilliseconds(), 3)

                                return yyyy + MM + dd+  hh + mm + ss + ms;
                            };

                            function getDate() {
                                //d = new Date();
                                //alert(d.YYYYMMDDHHMMSSMS());
                                alert((new Date()).YYYYMMDDHHMMSSMS());
                            }

                            function pad(number, length) {
                                var str = '' + number;
                                while (str.length < length) {
                                    str = '0' + str;
                                }
                                return str;
                            }

                            function getTimestamp(){
                                return (new Date()).YYYYMMDDHHMMSSMS();
                            }

                            /**
                             * Delay for a number of milliseconds
                             */
                            function sleep(delay) {
                                var start = new Date().getTime();
                                while (new Date().getTime() < start + delay){
                                }
                            }

                            function deleteCookie()
                            {
                                var now = new Date();
                                now.setMonth( now.getMonth() - 1 );

                                var allcookies = document.cookie;
                                cookiearray = allcookies.split(';');

                                for(var i=0; i<cookiearray.length; i++){
                                    name = cookiearray[i].split('=')[0];
                                    value = cookiearray[i].split('=')[1];

                                    document.cookie = name + "=" + value + ";";
                                    document.cookie = "expires=" + now.toUTCString() + ";";
                                }
                            }

                            function writeCookie()
                            {
                                var now = new Date();
                                now.setMonth( now.getMonth() + 1 );

                                cookievalue= escape(getTimestamp()) + ";";
                                document.cookie="dce_chuchi_cookie_id=" + cookievalue;
                                document.cookie = "expires=" + now.toUTCString() + ";"
                            }

                            function getCookie()
                            {
                                var allcookies = document.cookie;
                                cookiearray = allcookies.split(';');

                                for(var i=0; i<cookiearray.length; i++) {
                                    name = cookiearray[i].split('=')[0];
                                    value = cookiearray[i].split('=')[1];

                                    if (name.trim() == "dce_chuchi_cookie_id") {
                                        return value;
                                    }
                                }
                            }

                            function reverse(s) {
                                return s.split('').reverse().join('');
                            }

                            var isLocalDetectClicked     = false;// used to tell the very first time or not ...
                            var isLocalRecognizeClicked  = false;
                            var isRemoteDetectClicked    = false;
                            var isRemoteRecognizeClicked = false;

                            var isLocalRecognizeClicked2  = false;
                            var isRemoteRecognizeClicked2 = false;

                            var connectedYet = false;

                            if(getCookie() == undefined){
                                //alert("dce_chuchi_cookie_id="+getCookie());
                                writeCookie();
                                //alert("dce_chuchi_cookie_id="+getCookie());
                            }

                            setMonitor("To Be Determined", "To Be Determined");

                            ////////////////////////////////////////////////////////////////////////////////////////////
                            // Put event listeners in place
                            window.addEventListener("DOMContentLoaded", function () {

                                getCookie();

                                ////////////////////////////////////////////////////////////////////////////////////////
                                // Grab elements, create settings, etc.
                                var selfCanvas = document.getElementById("selfCanvas"),// snapshot shown in self canvas
                                    selfContext = selfCanvas.getContext("2d"),
                                    selfVideo = document.getElementById("selfVideo"),
                                    selfVideoObj = {"video": true},
                                    selfErrBack = function (error) {
                                        console.log("Video capture error: ", error.code);
                                    };

//                                selfContext.translate(selfCanvas.width, 0);
//                                selfContext.scale(-1, 1);

                                ////////////////////////////////////////////////////////////////////////////////////////
                                // Grab elements, create settings, etc.
                                var callerCanvas = document.getElementById("callerCanvas"),// snapshot shown in caller canvas
                                    callerContext = callerCanvas.getContext("2d"),
                                    callerVideo = document.getElementById("callerVideo"),
                                    callerVideoObj = {"video": true},
                                    callerErrBack = function (error) {
                                        console.log("Video capture error: ", error.code);
                                    };

                                document.getElementById("selfSnap").addEventListener("click", function () {
                                    sendEvent('',  selfContext,   selfVideo,   selfCanvas,       getCookie()+"_localSnap.png",       "latest/localSnap.png", $(  '#selfImage'));
                                });

                                $('#selfDetect').click(function(){
                                    sendEvent('',  selfContext,   selfVideo,   selfCanvas,     getCookie()+"_localDetect.png",     "latest/localDetect.png", $(  '#selfImage'));
                                    isLocalDetectClicked = true;
                                })

                                $('#selfRecognize').click(function(){

                                    // if non-empty when click, train it.
                                    // if empty when click, do recognition.
                                    //
                                    var selfId=document.getElementById('selfId').value;
                                    //alert(selfId);
                                    sendEvent(selfId, selfContext,   selfVideo,   selfCanvas,  getCookie()+"_localRecognize.png",  "latest/localRecognize.png", $(  '#selfImage'));
                                    document.getElementById('selfId').value = '';
                                    //alert(selfId);

                                    isLocalRecognizeClicked = true;
                                    isLocalRecognizeClicked2 = true;
                                })

                                $('#selfTraining').click(function () {
                                    //alert($('#selfPwd').val());
                                    //alert($('#selfId').val());

                                    if($('#selfPwd').val().trim().length > 0){
                                        if($('#selfId').val().trim().length > 0){
                                            for (var i = 0; i < 20; i++) {// Note: We are sending 20 of pictures for training ...
                                                sleep(250);// Note: Taking a picture every .25 second. Hence, 20 * .25 = 5 second in total ...
                                                //var self_training_file_name = $('#selfPwd').val().trim() + "_" + $('#selfId').val().trim() + "_" + getTimestamp() + ".png";
                                                var self_training_file_name = "face_" + $('#selfId').val().trim() + "_" + getTimestamp() + ".png";
                                                //alert(self_training_file_name);
                                                sendEvent2(selfContext,   selfVideo,   selfCanvas,  self_training_file_name,  "latest/" + self_training_file_name, $('#selfImage'));
                                            }
                                        } else {
                                            alert("Please enter the user id.");
                                        }
                                    } else {
                                        alert("Please enter the group id.");
                                    }
                                    //$('#selfPwd').val('');
                                    //$('#selfId').val('');
                                })

                                document.getElementById("callerSnap").addEventListener("click", function () {
                                    sendEvent('', callerContext, callerVideo, callerCanvas,      getCookie()+"_remoteSnap.png",      "latest/remoteSnap.png", $('#callerImage'));
                                });

                                $('#callerDetect').click(function(){
                                    sendEvent('', callerContext, callerVideo, callerCanvas,    getCookie()+"_remoteDetect.png",    "latest/remoteDetect.png", $('#callerImage'));
                                    isRemoteDetectClicked = true;
                                })

                                $('#callerRecognize').click(function(){

                                    // if non-empty when click, train it
                                    // if empty when click, do recognition.
                                    //
                                    var callerId=document.getElementById('callerId').value;
                                    //alert(callerId);
                                    sendEvent(callerId, callerContext, callerVideo, callerCanvas, getCookie()+"_remoteRecognize.png", "latest/remoteRecognize.png", $('#callerImage'));
                                    document.getElementById('callerId').value = '';
                                    //alert(callerId);

                                    isRemoteRecognizeClicked = true;
                                    isRemoteRecognizeClicked2 = true;
                                })

                                if(resetCookieEnabled == true) {
                                    $('#getCookie').click(function () {
                                        //alert("get cookie");
                                        alert("dce_chuchi_cookie_id=" + getCookie());
                                    })
                                }

                                if(showCookieEnabled == true) {
                                    $('#setCookie').click(function () {
                                        //alert("set cookie");
                                        deleteCookie();
                                        writeCookie();
                                    })
                                }

                                ////////////////////////////////////////////////////////////////////////////////////////
                                // keep sending to the server ...
                                //
//                                setInterval(function () {
//                                    //if(connectedYet) {
//                                    if(isInitializer) {
//                                        sendEvent(selfId, selfContext, selfVideo, selfCanvas, getCookie() + "_localRecognize.png", "latest/localRecognize.png", $('#selfImage'));
////                                        if(true){
////
////
////
////                                            var lines = $('#selfLog').val().split("\n");
//////                                            if(lines.length > 0) {
//////                                                var lastLine = lines[lines.length - 1];
//////                                                alert("last: "+lastLine);
////                                                if(lines && lines.length > 1){
////                                                    var secondLastLine = lines[lines.length - 2];
////                                                    //alert("2nd last:" + secondLastLine);
////                                                    var fields = secondLastLine.split(",");
////                                                    selfContext.strokeStyle = "blue";
////                                                    selfContext.strokeRect(fields[3], fields[4], fields[5], fields[6]);
////
////
////                                                }
//////                                            }
////
////                                            //selfContext.strokeRect(10, 10, 100, 200);
////                                        }
//                                        isLocalRecognizeClicked = true;
//                                        isLocalRecognizeClicked2 = true;
//                                    }
//                                }, 3000);


                                if(true) {
                                    isBeginToSend = false;
                                    sendingRate = 100;
                                    setInterval(function () {
                                        //if(connectedYet) {
                                        $.get("latest/c2c_" + getCookie() + ".mapping", function (data) {
                                            if (data.endsWith(listenerFileName)) {
                                                isBeginToSend = true;
                                                sendingRate = 1000;
                                            }
                                        });
                                        if (isBeginToSend && isInitializer) {// initializer keeps sending to prove himself or herself !!!
//                                        sendEvent(
//                                                callerId,
//                                                callerContext,
//                                                callerVideo,
//                                                callerCanvas,
//                                                getCookie() + "_remoteRecognize.png",
//                                                "latest/remoteRecognize.png",
//                                                $('#callerImage'));

                                            sendEvent(selfId, selfContext, selfVideo, selfCanvas, getCookie() + "_localRecognize.png", "latest/localRecognize.png", $('#selfImage'));

                                            isRemoteRecognizeClicked = true;
                                            isRemoteRecognizeClicked2 = true;
                                        }
                                    }, sendingRate);
                                }

//                                listenerFileNameSet = false;
//                                setInterval(function () {
//                                    if(/*isInitializer == true*/isListener == true && listenerFileNameSet == false) {
//                                        //if (true) {//isLocalRecognizeClicked) {
//                                        $.get("latest/c2c_" + getCookie() + ".mapping", function (data) {
//                                            if(data.startsWith("c2c_") && data.endsWith(listenerFileName)){
//
//                                                alert(data);
//
//                                                listenerFileName = data;
//                                                $('#selfLog3').text(listenerFileName)// todo: issue here ... never true ...
//                                                listenerFileNameSet = true;
//                                            }
//                                        });
//                                        //}
//                                    }
//                                }, 100);
//
//
//                                if(remoteRecognizeEnabled == true) {

//                                if(true) {
//
//                                    isBeginToDownload = false;
//                                    askingRate = 100;
//                                    listenToCookieId = ""
//
//                                    $.get("latest/"+listenToCookieId+"remoteRecognize.latest", function (data) {
//                                        $('#callerLog').text(data)
//                                        document.getElementById("callerLog").scrollTop = document.getElementById("callerLog").scrollHeight;
//                                    });
//
//                                    $.get("latest/"+listenToCookieId+"remoteRecognize.log", function (data) {
//                                        $('#callerLog2').text(data)
//                                        document.getElementById("callerLog2").scrollTop = document.getElementById("callerLog2").scrollHeight;
//                                    });
//
//
//                                    setInterval(function () {
//                                        //if(connectedYet) {
//                                        $.get("latest/c2c_" + getCookie() + ".mapping", function (data) {
//                                            if (data.endsWith(listenerFileName)) {
//                                                isBeginToDownload = true;
//                                                askingRate = 1000;
//                                                listenToCookieId = data;
//                                            }
//                                        });
//
//                                        if(isListener == true && isBeginToDownload == true) {
//
////                                        if (/*isRemoteRecognizeClicked && listenerFileNameSet == true && */isBeginToDownload == true && isListener == true) {
////                                            //$('#callerImage2').attr("src", "latest/" + getCookie() + "_remoteRecognize.png?" + new Date().getTime());
////                                            $('#callerImage2').attr("src", "latest/" + listenerFileName + "?" + new Date().getTime());
////                                        }
////                                        else {
////                                            $('#callerImage2').attr("src", "latest/remoteRecognize.png?" + new Date().getTime());
////                                        }
//
//
//                                            $.get("latest/" + listenToCookieId + "_remoteRecognize.latest", function (data) {
//                                                $('#callerLog').text(data)
//                                                document.getElementById("callerLog").scrollTop = document.getElementById("callerLog").scrollHeight;
//                                            });
//
//
//                                            $.get("latest/" + listenToCookieId + "_remoteRecognize.log", function (data) {
//                                                $('#callerLog2').text(data)
//                                                document.getElementById("callerLog2").scrollTop = document.getElementById("callerLog2").scrollHeight;
//                                            });
//                                        }
//
//
//                                    }, askingRate);//500);
//                                }

//                                }



























                                setInterval(function () {
                                    if(connectedYet) {
                                        if(true){
                                            var lines = $('#selfLog').val().split("\n");
                                            if(lines && lines.length > 1){
                                                var secondLastLine = lines[lines.length - 2];
                                                var fields = secondLastLine.split(",");

                                                selfContext.strokeStyle = "blue";

                                                var x_cordinate = fields[3];//selfCanvas.width - fields[3] - fields[5];
                                                var y_cordinate = fields[4];
                                                var recognized_person = fields[1];// reverse(fields[1]);

                                                selfContext.fillStyle = "blue";
                                                selfContext.textAlign = "left";
                                                selfContext.font="30px Verdana";
                                                selfContext.fillText(recognized_person, x_cordinate, y_cordinate);
                                                selfContext.strokeRect(x_cordinate, y_cordinate, fields[5], fields[6]);
                                            }
                                        }
                                    }
                                }, 1000);

                                setInterval(function () {
                                    if(connectedYet) {
                                        if(true){
                                            var lines = $('#callerLog').val().split("\n");
                                            if(lines && lines.length > 1){
                                                var secondLastLine = lines[lines.length - 2];
                                                var fields = secondLastLine.split(",");

                                                callerContext.strokeStyle = "blue";

                                                var x_cordinate = fields[3];//selfCanvas.width - fields[3] - fields[5];
                                                var y_cordinate = fields[4];
                                                var recognized_person = fields[1];// reverse(fields[1]);

                                                callerContext.fillStyle = "blue";
                                                callerContext.textAlign = "left";
                                                callerContext.font="30px Verdana";
                                                callerContext.fillText(recognized_person, x_cordinate, y_cordinate);
                                                callerContext.strokeRect(x_cordinate, y_cordinate, fields[5], fields[6]);
                                            }
                                        }
                                    }
                                }, 1000);





                            }, false);








//                            if(localDetectEnabled == true) {
//                                setInterval(function () {
//                                    if (isLocalDetectClicked) {
//                                        $('#selfImage').attr("src", "latest/" + getCookie() + "_localDetect.png?" + new Date().getTime());
//                                    } else {
//                                        $('#selfImage').attr("src", "latest/localDetect.png?" + new Date().getTime());
//                                    }
//                                }, 500);
//                            }
//
//                            // Note: can comment it out if too slow ...
//                            if(remoteDetectEnabled == true) {
//                                setInterval(function () {
//                                    if (isRemoteDetectClicked) {
//                                        $('#callerImage').attr("src", "latest/" + getCookie() + "_remoteDetect.png?" + new Date().getTime());
//                                    } else {
//                                        $('#callerImage').attr("src", "latest/remoteDetect.png?" + new Date().getTime());
//                                    }
//                                }, 500);
//                            }
//
//                            if(localRecognizeEnabled == true) {
//                                setInterval(function () {
//                                    if (isLocalRecognizeClicked) {
//                                        $('#selfImage2').attr("src", "latest/" + getCookie() + "_localRecognize.png?" + new Date().getTime());
//                                    } else {
//                                        $('#selfImage2').attr("src", "latest/localRecognize.png?" + new Date().getTime());
//                                    }
//                                }, 1000);//500);
//                            }




//                            listenerFileNameSet = false;
//                            setInterval(function () {
//                                if(/*isInitializer == true*/isListener == true && listenerFileNameSet == false) {
//                                    //if (true) {//isLocalRecognizeClicked) {
//                                        $.get("latest/c2c_" + getCookie() + ".mapping", function (data) {
//                                            if(data.startsWith("c2c_") && data.endsWith(listenerFileName)){
//
//                                                alert(data);
//
//                                                listenerFileName = data;
//                                                $('#selfLog3').text(listenerFileName)// todo: issue here ... never true ...
//                                                listenerFileNameSet = true;
//                                            }
//                                        });
//                                    //}
//                                }
//                            }, 100);
//
//
//                            if(remoteRecognizeEnabled == true) {
//                                setInterval(function () {
//                                    if (/*isRemoteRecognizeClicked && listenerFileNameSet == true && */isListener == true) {
//                                        $('#callerImage2').attr("src", "latest/" + getCookie() + "_remoteRecognize.png?" + new Date().getTime());
//                                        //$('#callerImage2').attr("src", "latest/" + listenerFileName + "?" + new Date().getTime());
//                                    } else {
//                                        $('#callerImage2').attr("src", "latest/remoteRecognize.png?" + new Date().getTime());
//                                    }
//                                }, 1000);//500);
//                            }





//                            if(true) {
//
//                                isBeginToDownload = false;
//                                askingRate = 100;
//                                listenToCookieId = ""
//
//                                $.get("latest/"+listenToCookieId+"remoteRecognize.latest", function (data) {
//                                    $('#callerLog').text(data)
//                                    document.getElementById("callerLog").scrollTop = document.getElementById("callerLog").scrollHeight;
//                                });
//
//                                $.get("latest/"+listenToCookieId+"remoteRecognize.log", function (data) {
//                                    $('#callerLog2').text(data)
//                                    document.getElementById("callerLog2").scrollTop = document.getElementById("callerLog2").scrollHeight;
//                                });
//
//
//                                setInterval(function () {
//                                    //if(connectedYet) {
//                                    $.get("latest/c2c_" + getCookie() + ".mapping", function (data) {
//                                        if (data.endsWith(listenerFileName)) {
//                                            isBeginToDownload = true;
//                                            askingRate = 1000;
//                                            listenToCookieId = data;
//                                        }
//                                    });
//
//                                    if(isListener == true && isBeginToDownload == true) {
//
////                                        if (/*isRemoteRecognizeClicked && listenerFileNameSet == true && */isBeginToDownload == true && isListener == true) {
////                                            //$('#callerImage2').attr("src", "latest/" + getCookie() + "_remoteRecognize.png?" + new Date().getTime());
////                                            $('#callerImage2').attr("src", "latest/" + listenerFileName + "?" + new Date().getTime());
////                                        }
////                                        else {
////                                            $('#callerImage2').attr("src", "latest/remoteRecognize.png?" + new Date().getTime());
////                                        }
//
//
//                                        $.get("latest/" + listenToCookieId + "_remoteRecognize.latest", function (data) {
//                                            $('#callerLog').text(data)
//                                            document.getElementById("callerLog").scrollTop = document.getElementById("callerLog").scrollHeight;
//                                        });
//
//
//                                        $.get("latest/" + listenToCookieId + "_remoteRecognize.log", function (data) {
//                                            $('#callerLog2').text(data)
//                                            document.getElementById("callerLog2").scrollTop = document.getElementById("callerLog2").scrollHeight;
//                                        });
//                                    }
//
//
//                                }, askingRate);//500);
//                            }













//                            if(localRecognizeLogEnabled == true) {
//                                setInterval(function () {
//                                    if (isLocalRecognizeClicked) {
//                                        $.get("latest/" + getCookie() + "_localRecognize.latest", function (data) {
//                                            $('#selfLog').text(data)
//                                            document.getElementById("selfLog").scrollTop = document.getElementById("selfLog").scrollHeight;
//                                        });
//                                    } else {
//                                        $.get("latest/localRecognize.latest", function (data) {
//                                            $('#selfLog').text(data)
//                                            document.getElementById("selfLog").scrollTop = document.getElementById("selfLog").scrollHeight;
//                                        });
//                                    }
//                                }, 250);
//                            }
//
//                            if(localRecognizeLogEnabled2 == true) {
//                                setInterval(function () {
//                                    if (isLocalRecognizeClicked2) {
//                                        $.get("latest/" + getCookie() + "_localRecognize.log", function (data) {
//                                            $('#selfLog2').text(data)
//                                            document.getElementById("selfLog2").scrollTop = document.getElementById("selfLog2").scrollHeight;
//
//
//
//                                            rIdAndScore = lastLog(4, data);
//                                            setMonitor(rIdAndScore[0], rIdAndScore[1]);
//                                            // above ... eventually will be a function to call in remote recognize code
//
//
//
//                                        });
//                                    } else {
//                                        $.get("latest/localRecognize.log", function (data) {
//                                            $('#selfLog2').text(data)
//                                            document.getElementById("selfLog2").scrollTop = document.getElementById("selfLog2").scrollHeight;
//                                        });
//                                    }
//                                }, 250);
//                            }


















                            if(remoteRecognizeLogEnabled == true) {

                                isBeginToDownload = false;
                                askingRate = 100;
                                listenToCookieId = ""

                                $.get("latest/"+listenToCookieId+"remoteRecognize.latest", function (data) {
                                    $('#callerLog').text(data)
                                    document.getElementById("callerLog").scrollTop = document.getElementById("callerLog").scrollHeight;
                                });

                                setInterval(function () {

                                    $.get("latest/c2c_" + getCookie() + ".mapping", function (data) {
                                        if (data.endsWith(listenerFileName)) {
                                            isBeginToDownload = true;
                                            askingRate = 250;
                                            listenToCookieId = data;
                                        }
                                    });


                                    if(isListener == true && isBeginToDownload == true) {

                                        //$('#callerLog').text(listenToCookieId.substring(0, listenToCookieId.indexOf("_")))
                                        $.get("latest/" + listenToCookieId.substring(0, listenToCookieId.indexOf("_")) + "_localRecognize.latest", function (data) {
                                            $('#callerLog').text(data)
                                            document.getElementById("callerLog").scrollTop = document.getElementById("callerLog").scrollHeight;
                                        });
                                    }

                                }, askingRate);//250);
                            }

                            if(remoteRecognizeLogEnabled2 == true) {

                                isBeginToDownload2 = false;
                                askingRate2 = 100;
                                listenToCookieId2 = ""

                                $.get("latest/remoteRecognize.log", function (data) {
                                    $('#callerLog2').text(data)
                                    document.getElementById("callerLog2").scrollTop = document.getElementById("callerLog2").scrollHeight;
                                });

                                setInterval(function () {

                                    $.get("latest/c2c_" + getCookie() + ".mapping", function (data) {
                                        if (data.endsWith(listenerFileName)) {
                                            isBeginToDownload2 = true;
                                            askingRate2 = 250;
                                            listenToCookieId2 = data;
                                        }
                                    });



                                    if (isListener == true && isBeginToDownload == true) {


                                            $.get("latest/" + listenToCookieId.substring(0, listenToCookieId.indexOf("_")) + "_localRecognize.log", function (data) {
                                                $('#callerLog2').text(data)
                                                document.getElementById("callerLog2").scrollTop = document.getElementById("callerLog2").scrollHeight;

                                            });
                                    }
                                }, askingRate2);
                            }

                         </script>

                        <div id="acceptCallBox"> <!-- Should be initially hidden using CSS -->
                            <div id="acceptCallLabel"></div>
                            <button id="callAcceptButton" >Accept :)</button> <button id="callRejectButton">Reject :(</button>
                        </div>

                    </div>
                </div>
                <!--hide-->
                <!--<br style="clear:both;" />-->
                <!--<hr />-->

                <!--<h2>The Code</h2>-->
                <!--<h3>HTML</h3>-->
                <!--<pre id="prettyHtml" class="prettyprint linenums:1">-->
                <!--</pre>-->
                <!--<h3>JavaScript</h3>-->
                <!--<p>The contents of demo_video_only.js:</p>-->
                <!--<pre id="prettyJS" class="prettyprint linenums:1" style="white-space: pre-wrap;">-->
                <!--</pre>-->


                <!-- Runs the SyntaxHighlighter -->
                <!--<script type="text/javascript">-->
                    <!--loadAndFilter(window.location.href, "prettyHtml",2 );-->
                    <!--loadAndFilter(getHelperPath("js"), "prettyJS", 2);-->
                <!--</script>-->

                <!-- End Main Content -->
            </div>
            <!--<div id="footer">-->
                <!--<a href="http://www.priologic.com/?from=landing"><img id="logo_priologic" src="images/priologic_logo_white.png" height="40" width="150" alt="Created By Priologic Software Inc." /></a>-->
                <!--<a href="http://www.easyrtc.com/?from=landing"><img id="logo_pb_easyrtc" src="/easyrtc/img/powered_by_easyrtc.png" height="60" width="200" alt="Powered By EasyRTC" /></a>-->
                <!--<p><em>&copy; 2015 - Priologic Software Inc., All Rights Reserved.</em></p>-->
                <!--<p id="license">EasyRTC source code released under a BSD2 License. <a href="https://github.com/priologic/easyrtc/blob/master/LICENSE">See LICENSE file in project folder</a> for details.</p>-->
            <!--</div>-->
        </div>
        <!--show-->
    </body>
</html>
