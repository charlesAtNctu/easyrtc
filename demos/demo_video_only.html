<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />  <!--skip-->
        <title>EasyRTC Demo: Video Only</title>
                <link rel="stylesheet" type="text/css" href="/easyrtc/easyrtc.css" />

        <!--hide-->
        <link rel="stylesheet" type="text/css" href="css/landing.css" />


        <!-- Prettify Code -->
        <script type="text/javascript" src="js/prettify/prettify.js"></script>
        <script type="text/javascript" src="js/prettify/loadAndFilter.js"></script>
        <script type="text/javascript" src="js/prettify/jquery.min.js"></script>

        <link rel="stylesheet" type="text/css" href="js/prettify/prettify.css" />
        <!--show-->
        <!-- Assumes global locations for socket.io.js and easyrtc.js -->
        <script src="/socket.io/socket.io.js"></script>
        <script type="text/javascript" src="/easyrtc/easyrtc.js"></script>
        <script type="text/javascript" src="js/demo_video_only.js"></script>
        <!--hide-->
        <!-- Styles used within the demo -->
        <style type="text/css">
            #videoDemoContainer {
                position:relative;
            }
            #connectControls {
                float:left;
                width:250px;
                text-align:center;
                border: 2px solid black;
            }
            #otherClients {
                height:200px;
                overflow-y:scroll;
            }
            #selfVideo {
                height:225px;
                width:300px;
                float:left;
                border:1px solid gray;
                margin-left:10px;
            }
            #callerVideo {
                height:225px;
                width:300px;
                border:1px solid gray;
                margin-left:10px;
            }
            #acceptCallBox {
                display:none;
                z-index:2;
                position:absolute;
                top:100px;
                left:400px;
                border:red solid 2px;
                background-color:pink;
                padding:15px;
            }
        </style>
        <!--show-->
    </head>
    <body>
        <!--hide-->
        <div id="container">
            <div id="header">
                <a href="index.html"><img id="logo_easyrtc" src="images/easyrtc_logo.png" alt="EasyRTC" style="" /></a>
            </div>
            <div id="menu"><a class="menu_link" href="index.html"><div class="menu_item">Local Demos</div></a><a class="menu_link" href="https://github.com/priologic/easyrtc/tree/master/docs"><div class="menu_item">Documentation</div></a><a class="menu_link" href="https://easyrtc.com/forums/"><div class="menu_item">Support: EasyRTC Forums</div></a><a class="menu_link" href="http://www.easyrtc.com/"><div class="menu_item">EasyRTC.com</div></a></div>
            <div id="main">
                <!-- Main Content -->
                <h1>EasyRTC Demo: Video Only</h1>

                <p>The application provides a video-only chat by disabling audio before initializing the local media stream.</p>

                <p>To use it, press the Connect button.
                    You should see buttons representing other people using the video-only chat page.
                    Click one of those buttons to initiate a chat.</p>

                <hr />
                <h2>The Demo</h2>
                <!--show-->
                <div id="videoDemoContainer">
                    <div id="connectControls">
                        <button id="connectButton" onclick="connect()">Connect</button>
                        <button id="hangupButton" disabled="disabled" onclick="hangup()">Hangup</button>
                        <div id="iam">Not yet connected...</div>
                        <br />
                        <strong>Connected users:</strong>
                        <div id="otherClients"></div>
                    </div>

                    <div id="videos">

                        <table>
                            <tr>
                                <td>
                                    <video autoplay="autoplay" id="selfVideo" class="easyrtcMirror"></video>
                                </td>
                                <td>
                                    <video autoplay="autoplay" id="callerVideo"></video>
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    <button id="selfSnap"        class="sexyButton">Self   Snap      </button>
                                    <button id="selfDetect"      class="sexyButton">Self   Detect    </button>
                                    <button id="selfRecognize"   class="sexyButton">Self   Recognize </button>
                                </td>
                                <td>
                                    <button id="callerSnap"      class="sexyButton">Caller Snap      </button>
                                    <button id="callerDetect"    class="sexyButton">Caller Detect    </button>
                                    <button id="callerRecognize" class="sexyButton">Caller Recognize </button>
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    <canvas id="selfCanvas" width="320" height="240"></canvas>
                                </td>
                                <td>
                                    <canvas id="callerCanvas" width="320" height="240"></canvas>
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    <img id="selfImage" width="320" height="240"></img>
                                </td>
                                <td>
                                    <img id="callerImage" width="320" height="240"></img>
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    <p><b id='selfJson'></b></p>
                                </td>
                                <td>
                                    <p><b id='callerJson'></b></p>
                                </td>
                            </tr>
                        </table>

                        <!-- cliu: the following can be commented out -->
                        <!--<p id="selfPngHolder"></p>-->
                        <!--<p id="callerPngHolder"></p>-->

                        <script>

                            // Converts image to canvas; returns new canvas element
                            function convertImageToCanvas(image) {
                                var canvas = document.createElement("canvas");
                                canvas.width = image.width;
                                canvas.height = image.height;
                                canvas.getContext("2d").drawImage(image, 0, 0);

                                return canvas;
                            }

                            // Converts canvas to an image
                            function convertCanvasToImage(canvas) {
                                var image = new Image();
                                image.src = canvas.toDataURL("image/png");
                                return image;
                            }

                            function getBase64Image(imgElem) {
                                // imgElem must be on the same server otherwise a cross-origin error will be thrown "SECURITY_ERR: DOM Exception 18"
                                var canvas = document.createElement("canvas");
                                canvas.width = imgElem.clientWidth;
                                canvas.height = imgElem.clientHeight;
                                var ctx = canvas.getContext("2d");
                                ctx.drawImage(imgElem, 0, 0);
                                var dataURL = canvas.toDataURL("image/png");
                                return dataURL.replace(/^data:image\/(png|jpg);base64,/, "");
                            }

                            function getBase64Image(img, extension) {
                                // Create an empty canvas element
                                var canvas = document.createElement('canvas');

                                canvas.width = img.naturalWidth;
                                canvas.height = img.naturalHeight;

                                // Copy the image contents to the canvas
                                var ctx = canvas.getContext('2d');
                                ctx.drawImage(img, 0, 0);

                                // Get the data-URL formatted image
                                // Firefox supports PNG and JPEG. You could check img.src to
                                // guess the original format, but be aware the using 'image/jpg'
                                // will re-encode the image.
                                var dataURL = canvas.toDataURL('image/' + extension);

                                return dataURL;
                            }

                            function dataURItoBlob(dataURI) {
                                // convert base64/URLEncoded data component to raw binary data held in a string
                                var byteString;
                                if (dataURI.split(',')[0].indexOf('base64') >= 0)
                                    byteString = atob(dataURI.split(',')[1]);
                                else
                                    byteString = unescape(dataURI.split(',')[1]);

                                // separate out the mime component
                                var mimeString = dataURI.split(',')[0].split(':')[1].split(';')[0];

                                // write the bytes of the string to a typed array
                                var ia = new Uint8Array(byteString.length);
                                for (var i = 0; i < byteString.length; i++) {
                                    ia[i] = byteString.charCodeAt(i);
                                }

                                return new Blob([ia], {type:mimeString});
                            }


                            function uploadFile(e) {
                                var img         = e.target,
                                        imgPath     = img.src,
                                        pathParts   = imgPath.split('/'),
                                        filename    = pathParts[pathParts.length - 1],
                                        extension   = filename.split('.')[1],
                                        imgData     = getBase64Image(img, extension),
                                        formData    = new FormData(),
                                        xhttp       = new XMLHttpRequest(),
                                        file

                                file = dataURItoBlob(imgData)
                                formData.append('uploads[]', file, filename)

                                img.parentElement.classList.remove('img-error')
                                img.parentElement.classList.add('img-uploading')

                                xhttp.onreadystatechange = function() {
                                    if (xhttp.readyState == 4) {
                                        if(xhttp.status == 200) {
                                            setTimeout(showSuccess.bind(this), 1500)
                                        } else {
                                            setTimeout(showError.bind(this), 1500)
                                        }

                                    }
                                }.bind(this);

                                xhttp.open('POST', '/upload');
                                xhttp.send(formData);
                            }

                            function showSuccess() {
                                this.parentElement.classList.remove('img-uploading')
                            }

                            function showError() {
                                this.parentElement.classList.remove('img-uploading')
                                this.parentElement.classList.add('img-error')
                            }

                            function sendEvent(context, video, canvas, filename, resultingfilepath, imageElem) {
                                context.drawImage(video, 0, 0, 320, 240);

                                var image = convertCanvasToImage(canvas);

                                var formData    = new FormData(),
                                    xhttp       = new XMLHttpRequest(),
                                    file        = dataURItoBlob(image.src)

                                //filename = "localDetect.png";

                                formData.append('uploads[]', file, filename)

                                //image.parentElement.classList.remove('img-error')
                                //image.parentElement.classList.add('img-uploading')

                                xhttp.onreadystatechange = function() {
                                    if (xhttp.readyState == 4) {
                                        if(xhttp.status == 200) {
                                            setTimeout(showSuccess.bind(this), 1500)

                                            sDetect = new Image();
                                            sDetect.src = resultingfilepath; // can also be a remote URL e.g. http://
                                            sDetect.onload = function() {

//                                                console.info("resetting the source ... :)")

                                                d = new Date();
                                                imageElem.attr("src", sDetect.src + "?" + d.getTime());

                                                //canvas.width = canvas.width;
                                                //context.clearRect(0, 0, canvas.width, canvas.height);
                                                //context.drawImage(sDetect,0,0, 320, 240);
                                            };

                                        } else {
                                            setTimeout(showError.bind(this), 1500)


//                                            sDetect = new Image();
//                                            sDetect.src = resultingfilepath; // can also be a remote URL e.g. http://
//                                            sDetect.onload = function() {
//
//                                                console.info("resetting the source ... :)")
//
//                                                d = new Date();
//                                                $('#selfImage').attr("src", sDetect.src + "?" + d.getTime());
//
//                                                //canvas.width = canvas.width;
//                                                //context.clearRect(0, 0, canvas.width, canvas.height);
//                                                //context.drawImage(sDetect,0,0, 320, 240);
//                                            };
                                        }

                                    }
                                }.bind(this);

                                xhttp.open('POST', '/upload');
                                xhttp.send(formData);


//                                sDetect = new Image();
//                                sDetect.src = resultingfilepath; // can also be a remote URL e.g. http://
//                                sDetect.onload = function() {
//
//                                    console.info("resetting the source ... :)")
//
//                                    d = new Date();
//                                    $('#selfImage').attr("src", sDetect.src + "?" + d.getTime());
//
//                                    //canvas.width = canvas.width;
//                                    //context.clearRect(0, 0, canvas.width, canvas.height);
//                                    //context.drawImage(sDetect,0,0, 320, 240);
//                                };

                                // http://stackoverflow.com/questions/8977369/drawing-png-to-a-canvas-element-not-showing-transparency
                                //
                                // Don't forget to add an event listener to the image's load event. Image loading is something that happens in the background, so when the JavaScript interpreter gets to the canvas.drawImage part it is most likely the image probably will not have loaded yet and is just an empty image object, without content.
                                //
                                //sDetect = new Image();
                                //sDetect.src = "self/detects/localSelf.png"; // can also be a remote URL e.g. http://
                                //sDetect.onload = function() {
                                //    selfContext.drawImage(sDetect,0,0, 320, 240);
                                //};


                            }

                            // Put event listeners into place
                            window.addEventListener("DOMContentLoaded", function () {

                                ////////////////////////////////////////////////////////////////////////////////////////
                                // Grab elements, create settings, etc.
                                var selfCanvas = document.getElementById("selfCanvas"),// snapshot shown in self canvas
                                    selfContext = selfCanvas.getContext("2d"),
                                    selfVideo = document.getElementById("selfVideo"),
                                    selfVideoObj = {"video": true},
                                    selfErrBack = function (error) {
                                        console.log("Video capture error: ", error.code);
                                     };

                                ////////////////////////////////////////////////////////////////////////////////////////
                                // Grab elements, create settings, etc.
                                var callerCanvas = document.getElementById("callerCanvas"),// snapshot shown in caller canvas
                                    callerContext = callerCanvas.getContext("2d"),
                                    callerVideo = document.getElementById("callerVideo"),
                                    callerVideoObj = {"video": true},
                                    callerErrBack = function (error) {
                                        console.log("Video capture error: ", error.code);
                                     };


                                // Trigger photo take
                                document.getElementById("selfSnap").addEventListener("click", function () {

                                    sendEvent(selfContext, selfVideo, selfCanvas, "localSnap.png", "latest/localSnap.png", $('#selfImage'));

//                                    ////////////////////////////////////////////////////////////////////////////////////
//                                    selfContext.drawImage(selfVideo, 0, 0, 320, 240);
//
////                                    // video -> canvas -> image
////                                    var selfPngHolder = document.getElementById("selfPngHolder");
////                                    selfPngHolder.removeChild(selfPngHolder.childNodes[0]);
////                                    var selfImage = convertCanvasToImage(selfCanvas)
////                                    selfPngHolder.appendChild(selfImage);
                                });

                                $('#selfDetect').click(function(){

                                    sendEvent(selfContext, selfVideo, selfCanvas, "localDetect.png", "latest/localDetect.png", $('#selfImage'));
                                    sendEvent(selfContext, selfVideo, selfCanvas, "localDetect.png", "latest/localDetect.png", $('#selfImage'));// testing ...

//                                    selfContext.drawImage(selfVideo, 0, 0, 320, 240);
//
//                                    var selfImage = convertCanvasToImage(selfCanvas);
//
//                                    var formData    = new FormData(),
//                                        xhttp       = new XMLHttpRequest(),
//                                        file        = dataURItoBlob(selfImage.src)
//
//                                    filename = "localDetect.png";
//
//                                    formData.append('uploads[]', file, filename)
//
//                                    //selfImage.parentElement.classList.remove('img-error')
//                                    //selfImage.parentElement.classList.add('img-uploading')
//
//                                    xhttp.onreadystatechange = function() {
//                                        if (xhttp.readyState == 4) {
//                                            if(xhttp.status == 200) {
//                                                setTimeout(showSuccess.bind(this), 1500)
//
//                                                sDetect = new Image();
//                                                sDetect.src = "local/detects/localDetect.png"; // can also be a remote URL e.g. http://
//                                                sDetect.onload = function() {
//                                                    selfContext.drawImage(sDetect,0,0, 320, 240);
//                                                };
//
//                                            } else {
//                                                setTimeout(showError.bind(this), 1500)
//                                            }
//
//                                        }
//                                    }.bind(this);
//
//                                    xhttp.open('POST', '/upload');
//                                    xhttp.send(formData);
//
//                                    // http://stackoverflow.com/questions/8977369/drawing-png-to-a-canvas-element-not-showing-transparency
//                                    //
//                                    // Don't forget to add an event listener to the image's load event. Image loading is something that happens in the background, so when the JavaScript interpreter gets to the canvas.drawImage part it is most likely the image probably will not have loaded yet and is just an empty image object, without content.
//                                    //
//                                    //sDetect = new Image();
//                                    //sDetect.src = "self/detects/localSelf.png"; // can also be a remote URL e.g. http://
//                                    //sDetect.onload = function() {
//                                    //    selfContext.drawImage(sDetect,0,0, 320, 240);
//                                    //};
                                })

                                $('#selfRecognize').click(function(){

                                    sendEvent(selfContext, selfVideo, selfCanvas, "localRecognize.png", "latest/localRecognize.png", $('#selfImage'));

//                                    selfContext.drawImage(selfVideo, 0, 0, 320, 240);
                                })

                                document.getElementById("callerSnap").addEventListener("click", function () {

                                    sendEvent(callerContext, callerVideo, callerCanvas, "remoteSnap.png", "latest/remoteSnap.png", $('#callerImage'));

//                                    ////////////////////////////////////////////////////////////////////////////////////
//                                    callerContext.drawImage(callerVideo, 0, 0, 320, 240);
//
////                                    // video -> canvas -> image
////                                    var callerPngHolder = document.getElementById("callerPngHolder");
////                                    callerPngHolder.removeChild(callerPngHolder.childNodes[0]);
////                                    var callerImage = convertCanvasToImage(callerCanvas)
////                                    callerPngHolder.appendChild(callerImage);
                                });

                                $('#callerDetect').click(function(){

                                    sendEvent(callerContext, callerVideo, callerCanvas, "remoteDetect.png", "latest/remoteDetect.png", $('#callerImage'));
                                    sendEvent(callerContext, callerVideo, callerCanvas, "remoteDetect.png", "latest/remoteDetect.png", $('#callerImage'));// testing ...

                                    //document.getElementById('callerJson').innerHTML = 'RESPONSE';
                                })

                                $('#callerRecognize').click(function(){

                                    sendEvent(callerContext, callerVideo, callerCanvas, "remoteRecognize.png", "latest/remoteRecognize.png", $('#callerImage'));

                                    //callerContext.drawImage(callerVideo, 0, 0, 320, 240);
                                })

                            }, false);

                         </script>










                        <div id="acceptCallBox"> <!-- Should be initially hidden using CSS -->
                            <div id="acceptCallLabel"></div>
                            <button id="callAcceptButton" >Accept</button> <button id="callRejectButton">Reject</button>
                        </div>
                    </div>
                </div>
                <!--hide-->
                <br style="clear:both;" />
                <hr />

                <h2>The Code</h2>
                <h3>HTML</h3>
                <pre id="prettyHtml" class="prettyprint linenums:1">
                </pre>
                <h3>JavaScript</h3>
                <p>The contents of demo_video_only.js:</p>
                <pre id="prettyJS" class="prettyprint linenums:1" style="white-space: pre-wrap;">
                </pre>


                <!-- Runs the SyntaxHighlighter -->
                <script type="text/javascript">
                    loadAndFilter(window.location.href, "prettyHtml",2 );
                    loadAndFilter(getHelperPath("js"), "prettyJS", 2);
                </script>

                <!-- End Main Content -->
            </div>
            <div id="footer">
                <a href="http://www.priologic.com/?from=landing"><img id="logo_priologic" src="images/priologic_logo_white.png" height="40" width="150" alt="Created By Priologic Software Inc." /></a>
                <a href="http://www.easyrtc.com/?from=landing"><img id="logo_pb_easyrtc" src="/easyrtc/img/powered_by_easyrtc.png" height="60" width="200" alt="Powered By EasyRTC" /></a>
                <p><em>&copy; 2015 - Priologic Software Inc., All Rights Reserved.</em></p>
                <p id="license">EasyRTC source code released under a BSD2 License. <a href="https://github.com/priologic/easyrtc/blob/master/LICENSE">See LICENSE file in project folder</a> for details.</p>
            </div>
        </div>
        <!--show-->
    </body>
</html>
